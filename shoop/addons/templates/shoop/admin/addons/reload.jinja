{% extends "shoop/admin/base.jinja" %}
{% from "shoop/admin/macros/general.jinja" import content_block %}
{% block title %}{% trans %}Addons{% endtrans %}{% endblock %}

{% block content %}
    <div class="container-fluid">
        <form method="post" id="addon_reload_form" target="reload-target" onsubmit="beginReload()">
            {% csrf_token %}
            {% call content_block(_("Reload Application Server"), "fa-refresh") %}
                {{ bs3.field(form.reload_method) }}
                <div class="row">
                    <div class="col-sm-8 col-sm-push-4 col-lg-6 col-lg-push-3">
                        <div class="text-warning">
                            <p><strong>{% trans %}When you reload the application server, it may take some time for the new instance of your application to properly initialize.{% endtrans %}</strong></p>
                            <p><strong>{% trans %}In addition, there is always a chance for the server to not properly initialize at all, in which case you may need to troubleshoot the problem yourself (or have a system administrator handy).{% endtrans %}</strong></p>
                        </div>
                        <h3>{% trans %}Reload steps{% endtrans %}</h3>
                        <ol>
                            <li>{% trans %}First reload to enable new addons{% endtrans %}</li>
                            <li>{% trans %}Running database migrations for new addons{% endtrans %}</li>
                            <li>{% trans %}Enabling static resources for new addons{% endtrans %}</li>
                            <li>{% trans %}Second reload for new resources{% endtrans %}</li>
                        </ol>
                        <hr>
                        <button id="reload-button" type="submit" class="btn btn-warning">
                            <i class="fa fa-refresh"></i>
                            {% trans %}Reload Application Server{% endtrans %}
                        </button>
                        <iframe name="reload-target" src="about:blank" frameborder="0" style="display: none"></iframe>
                    </div>
                </div>
                <div class="content-block" id="reload-log"></div>
            {% endcall %}
        </form>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    var reloadCheckTimer = null;
    var started_migrating = false;
    var reloadUrl = {{ request.path|json }};
    var reloadCheckUrl = {{ (request.path + "?ping=1")|json }};
    var migrateUrl = {{ (request.path + "?migrate=1")|json }};
    var collectstaticUrl = {{ (request.path + "?collectstatic=1")|json }};

    function stopCheckReload() {
        if(reloadCheckTimer) {
            clearInterval(reloadCheckTimer);
            reloadCheckTimer = null;
        }
    }

    function reloadApplication() {
        stopCheckReload();
        reloadCheckTimer = setInterval(checkReload, 2000);
        Messages.enqueue({tags: "info", text: "{% trans %}Reload initiated.{% endtrans %}"});
        $.ajax({type: "POST", url: reloadUrl, data: $("#addon_reload_form").serialize()});
    }

    function beginReload() {
        event.preventDefault();
        $("#reload-button").attr("disabled", true);
        reloadApplication();
    }

    function sendCommand(url, next) {
        $.ajax({
            type: "GET",
            url: url,
            success: function (data) {
                $("#reload-log").append("<pre><code>" + data.message + "</code></pre>");
                next();
            },
            error: function (response) {
                Messages.enqueue({tags: "error", text: "{% trans %}Error while reloading application.{% endtrans %}"});
                $("#reload-log").append("<pre><code>" + response.responseJSON.message + "</code></pre>");
            }
        });
    }

    function runCollectstatic() {
        Messages.enqueue({tags: "info", text: "{% trans %}Starting to collect static files.{% endtrans %}"});
        sendCommand(collectstaticUrl, reloadApplication);
    }

    function startMigrating() {
        started_migrating = true;
        Messages.enqueue({tags: "info", text: "{% trans %}Starting database migrations.{% endtrans %}"});
        sendCommand(migrateUrl, runCollectstatic);
    }

    function checkReload() {
        $.ajax({
            type: "GET",
            url: reloadCheckUrl,
            success: function() {
                Messages.enqueue({
                    tags: "success",
                    text: "{% trans %}Your Shoop seems to be back up!{% endtrans %}"
                });
                stopCheckReload();
                if (!started_migrating) {
                    startMigrating();
                }
            },
            error: function() {
                Messages.enqueue({
                    tags: "info",
                    text: "{% trans %}Your Shoop is not up yet. Trying again soon.{% endtrans %}"
                });
            }
        })
    }
</script>
{% endblock %}
